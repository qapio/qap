module Tdip.Qapio.Qaplet
extends "Qaplet.pkl"
import "Qaplet.pkl"
import "Ui/Ui.pkl" as UiQap
import "Tasks/Tasks.pkl" as TasksQap
import "Qapi/Qapi.pkl" as QapiQap
import "Assistant/Assistant.pkl" as AssistantQap


class ContextData {
  Extensions: Listing<Qap>
}

Ui: String?
Tasks: TasksQap.TasksProps?
Qapi: String?
Assistant: AssistantQap.AssistantProps?

local function GetQap(name: String, props: Any) =
  if (name == "Ui")
    new Qaplet.Qap {
      Id = name
      Module = "Tdip.Qapio.Ui"
      Props = new UiQap.UiProps {
        Paths {
          props.toString()
        }
      }
    }
  else if (name == "Tasks")
    new Qaplet.Qap {
      Id = name
      Module = "Tdip.Qapio.Tasks"
      Props = props
    }

  else if (name == "Qapi")
    new Qaplet.Qap {
      Id = name
      Module = "Tdip.Qapio.Qapi"
      Props = new QapiQap.QapiProps {
        Paths {
          props.toString()
        }
      }
    }
  else if (name == "Assistant")
    new Qaplet.Qap {
      Id = name
      Module = "Tdip.Qapio.Assistant"
      Props = props
    }
  else
    new Qaplet.Qap {
      Id = name
      Module = name
      Props = props
    }

local function GetExtensions(): Listing<Qap> =
  new Listing {
    for (p in this.toMap().entries.filter((t) -> t.key != "Id" && t.key != "Context" && t.value != null)) {
      GetQap(p.key, p.value)
    }
  }

output {
  value = new Dynamic {
    Id = module.Id
    Context = new ContextData {
      Extensions = GetExtensions()
    }
  }
}